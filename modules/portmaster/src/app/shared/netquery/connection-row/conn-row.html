<div class="flex flex-row items-center gap-2">
  <span class="verdict" [class.outdated]="isOutdated" [ngClass]="helper.getVerdictClass(conn)"></span>

  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-tertiary" fill="none" viewBox="0 0 24 24"
    stroke="currentColor" stroke-width="2" *ngIf="conn.internal"
    sfng-tooltip="Internal connection only displayed in developer mode">
    <path stroke-linecap="round" stroke-linejoin="round"
      d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
  </svg>

  <ng-container *ngIf="conn.domain as domain; else scopeTranslation">
    <sfng-netquery-scope-label [scope]="conn.domain" class="inline-block overflow-hidden overflow-ellipsis"
      style="direction: rtl" sfngAddToFilter="domain" [sfngAddToFilterValue]="conn.domain">
    </sfng-netquery-scope-label>
  </ng-container>

  <ng-template #scopeTranslation>
    <span sfngAddToFilter="scope" [sfngAddToFilterValue]="conn.scope">
      <ng-container [ngSwitch]="conn.scope">
        <span *ngSwitchCase="scopes.Global">Internet Peer-to-Peer</span>
        <span *ngSwitchCase="scopes.GlobalMulitcast">Internet Multicast</span>
        <span *ngSwitchCase="scopes.HostLocal">Device-Local</span>
        <span *ngSwitchCase="scopes.LinkLocal">LAN Peer-to-Peer</span>
        <span *ngSwitchCase="scopes.LocalMulticast">LAN Multicast</span>
        <span *ngSwitchCase="scopes.SiteLocal">LAN Peer-to-Peer</span>

        <span class="text-tertiary" *ngSwitchCase="scopes.Invalid">N/A</span>
        <span class="text-tertiary" *ngSwitchCase="scopes.Undefined">N/A</span>
        <span class="text-tertiary" *ngSwitchDefault>N/A</span>
      </ng-container>

      <span>{{ conn.direction === 'inbound' ? ' Incoming' : ' Outgoing'}}</span>
    </span>
  </ng-template>
</div>

<div [class.text-tertiary]="!conn.country" class="flex flex-row items-center justify-start gap-1"
  [sfngAddToFilter]="!!conn.country ? 'country' : null" [sfngAddToFilterValue]="conn.country">
  {{ conn | connectionLocation }}
</div>

<div>
  <span *ngIf="!!conn.__profile" class="flex flex-row items-center gap-1">
    <app-icon [profile]="conn.__profile"></app-icon>
    <span [sfngAddToFilter]="'profile'" [sfngAddToFilterValue]="conn.profile">{{ conn.__profile.Name }}</span>
  </span>
</div>

<div class="flex flex-row items-center gap-2">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transform"
    [ngClass]="{'rotate-180': conn.direction !== 'inbound', 'text-gray-600': !!conn.ended}" viewBox="0 0 20 20"
    fill="currentColor">
    <path fill-rule="evenodd"
      d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z"
      clip-rule="evenodd" />
  </svg>

  <span *ngIf="conn.type === 'ip'; else dnsRequest" sfngAddToFilter="remote_ip" [sfngAddToFilterValue]="conn.remote_ip">
    {{ conn.remote_ip }} <span *ngIf="conn.remote_port" class="text-secondary">:{{ conn.remote_port }}</span>
  </span>
  <ng-template #dnsRequest>
    <span class="text-secondary" sfngAddToFilter="type" sfngAddToFilterValue="dns">
      DNS Request
    </span>
  </ng-template>
</div>

<div class="text-secondary" [sfng-tooltip]="'Started ' + (conn.started | timeAgo:timeAgoTicker)">
  <ng-container *ngIf="!!conn.ended">
    <span>ended&nbsp;&nbsp;</span>
    {{ conn.ended | timeAgo:timeAgoTicker }}
  </ng-container>

  <ng-container *ngIf="!conn.ended">
    <span>started&nbsp;&nbsp;</span>
    {{ conn.started | timeAgo:timeAgoTicker }}
  </ng-container>
</div>

<div class="flex flex-row items-center justify-start gap-2">
  <ng-container *ngIf="conn.extra_data?.reason as reason">
    <ng-container *ngIf="reason.OptionKey">
      <span class="text-tertiary">applied</span>
      <span class="text-primary">{{ helper.settings[reason.OptionKey] || '' }}</span>
      <span class="text-tertiary">from</span>
      <span class="text-primary">{{
        !!reason.Profile ? "App" :
        "Global" }} Settings</span>
    </ng-container>
  </ng-container>
</div>

<div>
  <app-menu-trigger [menu]="ungroupedConnectionMenu"></app-menu-trigger>
  <app-menu #ungroupedConnectionMenu>
    <ng-container *ngIf="conn.extra_data?.reason as reason">
      <app-menu-item (onActivate)="helper.redirectToSetting('', conn)" *ngIf="!!reason.OptionKey">
        App Setting
      </app-menu-item>

      <app-menu-item (onActivate)="helper.redirectToSetting('', conn, true)" *ngIf="!!reason.OptionKey">
        Global Setting
      </app-menu-item>
    </ng-container>

    <app-menu-group class="separator"></app-menu-group>

    <app-menu-item *ngIf="(conn | isBlocked); else blockAction"
      (onActivate)="helper.unblockAll(conn.domain || conn.remote_ip, conn)" [disabled]="!(conn | canUseRules)">
      Allow {{ conn.domain ? 'Domain' : 'IP'}}
    </app-menu-item>

    <ng-template #blockAction>
      <app-menu-item (onActivate)="helper.blockAll(conn.domain || conn.remote_ip, conn)"
        [disabled]="!(conn | canUseRules)">
        Block {{ conn.domain ? 'Domain' : 'IP '}}
      </app-menu-item>
    </ng-template>


    <app-menu-item *appExpertiseLevel="'expert'" (click)="helper.dumpConnection(conn)">Copy JSON</app-menu-item>
  </app-menu>
</div>
