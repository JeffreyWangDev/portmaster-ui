<div
  class="sticky top-0 z-50 flex flex-row items-center w-full gap-2 py-2 mb-2 border-t border-b border-gray-200 bg-background"
  *ngIf="tagbarValues?.length">
  <sfng-netquery-tagbar [(ngModel)]="tagbarValues" (ngModelChange)="onTagbarChange($event)" [labels]="keyTranslation">
  </sfng-netquery-tagbar>

  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 cursor-pointer text-tertiary hover:text-primary" fill="none"
    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" (click)="copyQuery()"
    sfng-tooltip="Copy query to clipboard" snfgTooltipPosition="left">
    <path stroke-linecap="round" stroke-linejoin="round"
      d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
  </svg>

  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 cursor-pointer text-tertiary hover:text-primary"
    viewBox="0 0 20 20" fill="currentColor" (click)="clearQuery()" sfng-tooltip="Clear current query"
    snfgTooltipPosition="left">
    <path fill-rule="evenodd"
      d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
      clip-rule="evenodd" />
  </svg>
</div>

<div class="flex flex-row items-center w-full gap-2">
  <sfng-netquery-searchbar [(ngModel)]="textSearch" (ngModelChange)="performSearch()" class="block w-full"
    [labels]="keyTranslation" (onFieldsParsed)="onFieldsParsed($event)"></sfng-netquery-searchbar>
  <button type="button" class="h-full rounded-r-sm btn" (click)="performSearch()">Reload</button>
</div>

<div class="flex flex-row items-center w-full gap-3">
  <!--
    Search / Suggestion boxes for most-commonly used filters
  -->
  <ng-container *ngFor="let field of (models | keyvalue)">
    <ng-container *ngIf="field.value!.visible">
      <sfng-select mode="multi" [itemName]="keyTranslation[field.key] || field.key" dynamicValues="true"
        [placeholder]="keyTranslation[field.key] || field.key" [(ngModel)]="field.value!.searchValues"
        allowSearch="true" searchItemThreshold="5" itemLimit="10"
        [searchPlaceholder]="'Search' + (keyTranslation[field.key] || field.key)" minWidth="400" minHeight="300"
        (ngModelChange)="performSearch()" (onOpen)="loadSuggestion(field.key)"
        [dynamicValueTemplate]="dynamicValueTemplate">
        <ng-container *ngFor="let value of field.value?.suggestions; trackBy: trackSuggestion">

          <sfng-select-item *sfngSelectValue="value.Value; label:value.Value === '' ? 'N/A' : value.Value">
            <span *ngIf="field.key === 'country' && !!value.Name" [appCountryFlags]="value.Name"></span>
            <span class="flex-grow inline-block overflow-hidden overflow-ellipsis whitespace-nowrap"
              style="max-width: 20rem; direction: rtl;">
              <span style="direction: ltr; unicode-bidi: bidi-override;">
                {{ value.Name || 'N/A' }}
              </span>
            </span>
            <span class="pr-3 text-xxs text-tertiary">
              #{{ value.count }} connections
            </span>
          </sfng-select-item>

        </ng-container>
      </sfng-select>

      <ng-template #dynamicValueTemplate let-item>
        <sfng-select-item>
          <span *ngIf="field.key === 'country' && !!item.value" [appCountryFlags]="item.value"></span>
          <span class="flex-grow inline-block overflow-hidden overflow-ellipsis whitespace-nowrap"
            style="max-width: 20rem; direction: rtl;">
            <span style="direction: ltr; unicode-bidi: bidi-override;">
              {{ item.value || 'N/A' }}
            </span>
          </span>
        </sfng-select-item>
      </ng-template>
    </ng-container>
  </ng-container>

  <div class="flex-grow"></div>

  <!--
    Group-By selection
  -->
  <sfng-select mode="multi" itemName="Group By" placeholder="Group By" allowSearch="false" [(ngModel)]="groupByKeys"
    (ngModelChange)="performSearch()">
    <ng-container *ngFor="let value of allowedGroupBy">
      <sfng-select-item *sfngSelectValue="value">
        {{ keyTranslation[value] || value }}
      </sfng-select-item>
    </ng-container>
  </sfng-select>

  <!--
    Order-By selection
  -->
  <sfng-select mode="multi" itemName="Sort" placeholder="Sort" allowSearch="false" [(ngModel)]="orderByKeys"
    (ngModelChange)="performSearch()">
    <ng-container *ngFor="let value of allowedOrderBy">
      <sfng-select-item *sfngSelectValue="value">
        {{ keyTranslation[value] || value }}
      </sfng-select-item>
    </ng-container>
  </sfng-select>
</div>

<div *appExpertiseLevel="'developer'">
  <sfng-netquery-line-chart [data]="chartData" class="h-32 opacity-75"></sfng-netquery-line-chart>
</div>


<ng-template #headerTemplate let-data let-active="active">
  <div class="relative flex flex-row items-center w-full gap-3 px-3 bg-gray-200"
    [ngClass]="{'rounded-sm': !active, 'rounded-t-sm': active, 'py-2': !!data._group, 'py-1': !data._group}">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-all duration-150 transform"
      [class.rotate-90]="active" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd"
        d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
        clip-rule="evenodd" />
    </svg>

    <!-- Group-By VIew -->
    <ng-template [ngIf]="!!data._group" [ngIfElse]="connView">
      <app-count-indicator [count]="data.totalCount" [countAllowed]="data.countAllowed"></app-count-indicator>

      <span *ngFor="let key of groupByKeys" class="flex flex-row items-center gap-1 overflow-hidden whitespace-nowrap">
        <span class="text-xxs text-secondary" *ngIf="groupByKeys.length !== 1">{{ keyTranslation[key] || key }}</span>
        <span class="text-primary" *ngIf="key === 'country' && !!data[key]"
          [appCountryFlags]="data[key]">{{ data[key] || 'N/A' }}</span>


        <span style="direction: rtl" *ngIf="key !== 'domain'" class="overflow-hidden text-primary overflow-ellipsis">
          <span style="direction: ltr; unicode-bidi: bidi-override;">
            {{ data[key] || 'N/A' }}
          </span>
        </span>

        <sfng-netquery-scope-label *ngIf="key === 'domain'" [scope]="data[key]" style="direction: rtl"
          class="overflow-hidden text-primary overflow-ellipsis">
        </sfng-netquery-scope-label>
      </span>

      <div class="flex-grow"></div>
      <div>
        <app-menu-trigger [menu]="groupedMenu"></app-menu-trigger>
        <app-menu #groupedMenu>
          <app-menu-item (onActivate)="useAsFilter(data)">Use as filter</app-menu-item>
        </app-menu>
      </div>

      <ng-container *appExpertiseLevel="'developer'">
        <ng-container *ngIf="(data._chart | async) as chartData" class="relative">
          <sfng-netquery-line-chart [data]="$any(chartData)" showAxis="false" margin="0"
            class="absolute top-0 bottom-0 right-0 w-64 bg-gray-100 bg-opacity-25 border border-gray-400 border-opacity-25 rounded-r opacity-75 shadow-inner-xs">
          </sfng-netquery-line-chart>
        </ng-container>
        <!-- placeholder for the chart -->
        <div style="flex-basis: 14.5rem"></div>
      </ng-container>
    </ng-template>

    <ng-template #connView>
      <sfng-netquery-connection-row [conn]="data"></sfng-netquery-connection-row>
    </ng-template>

  </div>
</ng-template>

<h3 class="flex flex-row items-center justify-start gap-3">
  Results
  <span class="text-xxs text-secondary" *ngIf="!loading">#{{ paginator.total }} results</span>
</h3>
<sfng-pagination *ngIf="!loading; else: loadingTemplate" [source]="paginator" class="flex flex-col flex-grow">
  <ng-template [sfngPageContent]>
    <sfng-accordion-group class="flex flex-col gap-2 pr-4"
      *ngIf="!(paginator.pageLoading$ | async); else: loadingTemplate" [headerTemplate]="headerTemplate"
      singleMode="false">
      <sfng-accordion [data]="result" #accordion *ngFor="let result of (paginator.pageItems$ | async)">
        <div *ngIf="accordion.active" class="p-3 bg-opacity-75 border-gray-300 rounded-b-sm"
          [ngClass]="{'bg-gray-300 border-t': !result._group}">

          <!-- nested accordion for connections inside a group -->
          <ng-container *ngIf="result._group !== null; else: connectionDetails">
            <sfng-accordion-group class="flex flex-col gap-2 ml-4"
              *ngIf="(result._group | async) as connsPaginator; else: loadingTemplate" [headerTemplate]="headerTemplate"
              singleMode="false">

              <sfng-pagination [source]="connsPaginator" class="flex flex-col flex-grow gap-2">
                <ng-template [sfngPageContent]>
                  <sfng-accordion *ngFor="let conn of (connsPaginator.pageItems$ | async)" [data]="conn" #subAccordion>
                    <div *ngIf="subAccordion.active"
                      class="p-3 bg-gray-300 bg-opacity-75 border-t border-gray-300 rounded-b-sm">
                      <ng-container *ngTemplateOutlet="connectionDetails; context: {$implicit: conn}"></ng-container>
                    </div>
                  </sfng-accordion>
                </ng-template>
              </sfng-pagination>
            </sfng-accordion-group>
          </ng-container>

          <!-- connection template -->
          <ng-template #connectionDetails let-conn>
            <!-- ng-if used to delcare a local variable as an "alias" to (conn || result) -->
            <ng-container *ngIf="(conn || result) as data">
              <sfng-netquery-conn-details [conn]="data">
              </sfng-netquery-conn-details>
            </ng-container>
          </ng-template>
        </div>
      </sfng-accordion>
    </sfng-accordion-group>
  </ng-template>
</sfng-pagination>


<ng-template #loadingTemplate>
  <div class="flex flex-col items-center justify-center flex-grow gap-2 text-tertiary">
    <svg class="w-6 h-6 text-secondary animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
      </path>
    </svg>
    Loading connections ...
  </div>
</ng-template>

<div class="flex flex-row items-center justify-center flex-shrink-0 w-full gap-1 text-xxs text-tertiary"
  *appExpertiseLevel="'expert'">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 -mt-0.5 text-primary" viewBox="0 0 20 20" fill="currentColor">
    <path
      d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z" />
  </svg>
  <span class="font-semibold text-primary">Pro Tip:</span>
  <span class="protip">
    <ng-container *ngTemplateOutlet="proTips?.get(proTipIdx) || null"></ng-container>
  </span>
</div>

<ng-template #proTip>
  Press
  <pre>CTRL + Space</pre>
  on any page to bring up the quick search box.
</ng-template>

<ng-template #proTip>
  Use your keyboard arrows to navigate through the search suggestions. Press
  <pre>ENTER</pre> to search for the suggestion or use
  <pre>Shift + Enter</pre> to add it to the search text.
</ng-template>

<ng-template #proTip>
  Inside the search box, use
  <pre>Ctrl + Space</pre> to force loading suggestions.
</ng-template>

<ng-template #proTip>
  Use
  <pre>Shift + Click</pre> to add connection attributes to the current filter.
</ng-template>

<ng-template #proTip>
  Hold
  <pre>Shift</pre> to highlight attributes that can be used in the filter.
</ng-template>
