<div class="w-full gap-4 p-4 dashboard-grid">
  <header class="flex flex-row items-center justify-between w-full" id="header">
    <div class="flex flex-col flex-grow text-lg font-light text-white">
      <h1>
        Dashboard
        <sfng-tipup key="dashboardIntro" placement="left"></sfng-tipup>
      </h1>

      <span class="text-sm font-normal text-secondary">
        <ng-container *ngIf="!!profile; else: noUsername">
          Welcome back, <span class="text-primary">{{ profile.username }}</span>!
          <a *ngIf="profile?.state === '' && !!profile?.username" class="text-xs underline cursor-pointer text-tertiary" (click)="logoutCompletely($event)">Clear</a>
        </ng-container>
        <ng-template #noUsername>
          Welcome back!
        </ng-template>
      </span>
      <span class="font-light text-xs text-green-300 mt-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-left-fill inline-block h-4 -mt-1" viewBox="0 0 16 16">
          <path d="m3.86 8.753 5.482 4.796c.646.566 1.658.106 1.658-.753V3.204a1 1 0 0 0-1.659-.753l-5.48 4.796a1 1 0 0 0 0 1.506z"/>
        </svg>
        New: Click shield to open dashboard
      </span>
    </div>

    <div class="flex flex-row gap-8">
      <div class="flex flex-col text-xs leading-4">
        <span class="font-light text-secondary">
          Your current plan is
          <span class="font-normal text-primary">
            {{ profile?.current_plan?.name || 'Portmaster Free' }}
          </span>
        </span>

        <span class="font-light text-secondary" *ngIf="!profile?.subscription?.next_billing_date">
          and ends
          <ng-container *ngIf="profile?.subscription?.ends_at; else: endsNever">
            in
            <span class="font-normal text-primary">
              {{ profile?.subscription?.ends_at! | timeAgo }}
            </span>
          </ng-container>
          <ng-template #endsNever>
            never
          </ng-template>
        </span>
        <span class="font-light text-secondary" *ngIf="!!profile?.subscription?.next_billing_date">
          and auto-renews in <span class="font-normal text-primary">
            {{ profile?.subscription?.next_billing_date! | timeAgo }}
          </span>
        </span>
      </div>

      <ng-container *ngIf="!!profile && profile.state !== ''; else: loginButton">
        <button (click)="openAccountDetails()"
          class="text-sm font-normal text-white cursor-pointer btn bg-blue bg-opacity-80 hover:bg-opacity-100 hover:bg-blue">
          Account Details
        </button>
      </ng-container>
      <ng-template #loginButton>
        <button (click)="openAccountDetails()"
          class="text-sm font-normal text-white cursor-pointer btn bg-blue bg-opacity-80 hover:bg-opacity-100 hover:bg-blue">
          Login / Subscribe
        </button>
      </ng-template>
    </div>
  </header>


  <div class="feature-card-container" id="features">
    <label>
      Features
    </label>

    <div class="feature-card-list">
      <app-feature-card *ngFor="let feature of (features$ | async)" [feature]="feature" [disabled]="!feature.enabled">
      </app-feature-card>
    </div>
  </div>


  <div class="feature-card-container" id="stats">
    <label>
      Recent Activity
    </label>

    <!-- Mini Stats -->
    <div class="mini-stats-list">
      <div class="mini-stat" routerLink="/monitor" [queryParams]="{q: 'verdict:3 verdict:4'}">
        <label routerLink="/monitor" [queryParams]="{q: 'verdict:3 verdict:4'}">Connections Blocked</label>
        <span>{{ blockedConnections }}</span>
      </div>

      <div class="mini-stat" routerLink="/monitor" [queryParams]="{q: 'active:true'}">
        <label routerLink="/monitor" [queryParams]="{q: 'active:true'}">Active Connections</label>
        <span>{{ activeConnections }}</span>
      </div>

      <div class="mini-stat" routerLink="/monitor" [queryParams]="{q: 'active:true groupby:profile'}">
        <label routerLink="/monitor" [queryParams]="{q: 'active:true groupby:profile'}">Active Apps</label>
        <span>{{ activeProfiles }}</span>
      </div>

      <div class="mini-stat">
        <label>Data Received</label>
        <span *ngIf="featureBw">
          {{ dataIncoming | bytes }}
        </span>
        <span *ngIf="!featureBw" class="!text-xxs !font-light !text-tertiary !text-opacity-50 w-full text-center !leading-3">
          Available in<br />Portmaster Plus
        </span>
      </div>

      <div class="mini-stat">
        <label>Data Sent</label>
        <span *ngIf="featureBw">
          {{ dataOutgoing | bytes }}
        </span>
        <span *ngIf="!featureBw" class="!text-xxs !font-light !text-tertiary !text-opacity-50 w-full text-center !leading-3">
          Available in<br />Portmaster Plus
        </span>
      </div>

      <div class="mini-stat" routerLink="/monitor" [queryParams]="{q: 'tunneled:true groupby:exit_node'}">
        <label routerLink="/monitor" [queryParams]="{q: 'tunneled:true groupby:exit_node'}">SPN Identities</label>
        <span *ngIf="featureSPN">{{ activeIdentities }}</span>
        <span *ngIf="!featureSPN" class="!text-xxs !font-light !text-tertiary !text-opacity-50 w-full text-center !leading-3">
          Available in<br />Portmaster Pro
        </span>
      </div>
    </div>
  </div>

  <div class="feature-card-container" id="charts">
    <div class="mini-stats-list">
      <div class="mini-stat">
        <label routerLink="/monitor">
          Active/Blocked Connections
        </label>
        <sfng-netquery-line-chart activeConnectionColor="text-green-300 text-opacity-70" class="w-full h-36"
          [data]="connectionChart"></sfng-netquery-line-chart>
      </div>
      <div class="mini-stat" *ngIf="featureSPN">
        <label routerLink="/monitor" [queryParams]="{q: 'tunneled:true'}">
          Connections Tunneled through SPN
        </label>
        <sfng-netquery-line-chart activeConnectionColor="text-blue"
          activeConnectionAreaColor="text-blue text-opacity-25" hideBlocked="true" class="w-full h-36"
          [data]="tunneldConnectionChart">
        </sfng-netquery-line-chart>
      </div>
    </div>
  </div>

  <div class="flex-grow feature-card-container" id="countries">
    <label>
      Recent Connections per Country
    </label>
    <div class="block w-full">
      <ul class="list-none auto-grid-4">
        <li *ngFor="let country of (connectionsPerCountry | keyvalue); trackBy: trackCountry"
          [routerLink]="['/monitor']" [queryParams]="{q: 'country:' + country.key}"
          (mouseenter)="onCountryHover(country.key)" (mouseleave)="onCountryHover(null)"
          class="flex flex-row items-center p-2 bg-gray-300 rounded-md cursor-pointer hover:bg-gray-400">
          <div class="flex flex-row items-center flex-grow gap-2">
            <span class="flex-shrink-0" *ngIf="!!country.key" [appCountryFlags]="country.key"></span>
            <span
              class="overflow-hidden text-xs text-secondary whitespace-nowrap">{{ countryNames[country.key] || country.key || 'N/A' }}</span>
          </div>
          <span class="ml-2">{{ country.value }}</span>
        </li>
      </ul>
    </div>
  </div>

  <div class="flex-grow feature-card-container" id="blocked">
    <label>
      Recently Blocked Applications
    </label>
    <div class="block w-full h-full">
      <span *ngIf="!(blockedProfiles |keyvalue)?.length" class="flex flex-row items-center justify-center h-full gap-2 text-tertiary">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
          class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
        </svg>

        <span>
          No applications have been blocked in the last 10 minutes.
        </span>
      </span>

      <ul class="list-none auto-grid-3">
        <li *ngFor="let profile of (blockedProfiles | keyvalue); trackBy: trackApp"
          (mouseenter)="onProfileHover(profile.key)" (mouseleave)="onProfileHover(null)"
          [routerLink]="['/app', profile.value.profile.Source, profile.value.profile.ID]"
          class="flex flex-row items-center p-2 bg-gray-300 rounded-md cursor-pointer hover:bg-gray-400">
          <div class="flex flex-row items-center flex-grow gap-2">
            <app-icon [profile]="profile.value.profile"></app-icon>
            <span class="text-xs text-secondary">{{ profile.value.profile.Name }}</span>
          </div>
          {{ profile.value.count }}
        </li>
      </ul>
    </div>
  </div>

  <div class="flex-grow feature-card-container" id="connmap">
    <label class="relative">
      Recent Connection Countries

      <!-- FIXME: Remove when map fully works as expected -->
      <div class="absolute top-0 right-0 flex flex-col items-center justify-center gap-0 text-yellow-200">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor" class="relative z-10 w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23-.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" />
        </svg>
        <span class="-mt-1 uppercase" style="font-size: 0.6rem">BETA</span>
      </div>

    </label>
    <div class="block w-full h-96" #map>
    </div>
  </div>
</div>
